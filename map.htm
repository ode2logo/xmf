<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta charset="UTF-8">
<meta name="description" content="Movil Fest 2016 Xplorer: mapa interactivo para recorrer virtual y físicamente este fascinante evento.">
<meta name="keywords" content="Movil Fest,Movil,Fest,Misiones,Posadas,Argentina,Tecnologia,Juegos,Anime,Robots,Videojuegos,Celulares,Tablets,Expo,Exposiciones">
<meta name="author" content="Emiliano Pujol">
<script src="jquery.js"></script>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width, height=device-height">
<script src="http://maps.google.com/maps/api/js?key=AIzaSyB0Scu9qFcbDn5mk3pSItJv6pL5W-TRHCE" type="text/javascript"></script>
<link rel="shortcut icon" href="favicon.png">
<link rel="icon" href="favicon.png">
<link rel="favicon" href="favicon.png">
<!--<LINK rel="StyleSheet" href="style.css?ra=1" type="text/css">
<LINK rel="StyleSheet" href="jquery.alerts.css" type="text/css">
<LINK rel="StyleSheet" href="jquery.ui.css" type="text/css">-->
<title>Movil Fest Xplorer</title>
<script>
//var $=window.parent.$.bind(window);
var introanimar=false;
var idventana=0;
var map;
var emap;
var imgPokes=[];
var imgPasto;
var arrPokes=[];
var pids=0;
var step=0;
var radius;
var avatar;
var error;
var canvas;
var opciones;
var menuOpciones;
var opcionesInner;
var tgop=false;
var M, N, H, W;
var lastPos;

function ret_sty(el,tg) {
    var ret;
    if (!tg) {
        if (el) ret={width:N*0.25,height:N*0.40,bottom:0,top:'auto',left:((W-N*0.2)/2)};
        else ret={width:N*1.1,bottom:-N*0.4,left:-N*0.325,backgroundImage:'none'};
    } else {
        if (el) ret={width:W,height:H,bottom:0,top:'auto',left:0};
        else ret={width:N*0.4,bottom:0,left:(W-N*0.4)/2,backgroundImage:'url(button.png)'};
    }
    return ret;
}


//$(window).load(function ()
$(window).resize(function() {
    W_resize();
});
$(document).ready(function () {
    radius=$("#radius");
    avatar=$("#avatar");
    error=$("#error");
    canvas=$("#canvas");
    opciones=$("#opciones");
    menuOpciones=$("#menuOpciones");
    opcionesInner=$("#opcionesInner");
    showError("Buscando señal GPS...");
    if (navigator.geolocation) {
        //if (!navigator.geolocation.watchPosition)
            //navigator.geolocation.getCurrentPosition(showPosition,function(v){showError("No se pudo obtener la ubicación GPS"+v.message)},{enableHighAccuracy:true});
        //else
            navigator.geolocation.watchPosition(showPosition,function(v){showError("No se pudo obtener la ubicación GPS")},{enableHighAccuracy:true});//*/
    } else
        showError("Disculpe, su navegador no soporta Geolocalización");

    setInterval(loop,500);
    W_resize();
    //inicializarMapa([-27.3831774,-55.8865714]);
    canvas.on("click",click);
    opciones.on("click",toggleOpciones);
    document.oncontextmenu=function(ev){ev.preventDefault();ev.stopPropagation();}
});

function showPosition(pos) {
    lastPos=pos;
    if (!map)
        inicializarMapa([pos.coords.latitude,pos.coords.longitude]);
    else {
        var latlng = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
        map.setCenter(latlng);
    }
    //alert(pos.coords.heading);
    emap.style.transform="rotate("+pos.coords.heading+"deg)";
    emap.style.webkitTransform="rotate("+pos.coords.heading+"deg)";
    emap.style.mozTransform="rotate("+pos.coords.heading+"deg)";
    emap.style.msTransform="rotate("+pos.coords.heading+"deg)";
    //if (!navigator.geolocation.watchPosition)
    //navigator.geolocation.getCurrentPosition(showPosition,function(v){showError("No se pudo obtener la ubicación GPS")},{enableHighAccuracy:true,timeout:10000});
}

function loop() {
    if (step%10==0) {
        radius.css({backgroundSize:'5%'}).animate({backgroundSize:'45%'},3000);
    }
    var r=rand(0,50);
    if (r<=2) {
        avatar.css({backgroundImage:"url("+(r==2?"avatar_r.png":"avatar_l.png")+")"});
    }
    if (map&&step>10) {
        checkPokes();
    }
    step++;
}

function click(ev) {
    ev.preventDefault();
    ev.stopPropagation();
    if (!map)
        return;
    var selfPos=map.getCenter();
    arrPokes.sort(function(a,b){return getDist(selfPos,a.getPosition())-getDist(selfPos,b.getPosition());});
    if (getDist(selfPos,arrPokes[0].getPosition())>0.0003) {
        showError("Acércate a alguno de los puestos marcados en el mapa.");
    } else {
        /*showError("Comienza una batalla...");
        location.href="battle.html#"+arrPokes[0].ref;*/
    }
}

function rand(ini,fin) {
    var d=fin-ini;
    return (Math.round(ini+Math.random()*d));
}

function getDist(p1,p2) {
    return (Math.sqrt(Math.pow(p1.lat()-p2.lat(),2)+Math.pow(p1.lng()-p2.lng(),2)))
}

function toggleOpciones() {
    //alert(1);
    var stmo=ret_sty(1,!tgop);
    var stop=ret_sty(0,!tgop);
    if (!tgop) {
        menuOpciones.animate(stmo,600);
        opciones.css({backgroundImage:stop.backgroundImage})
                .animate(stop,600);
        opcionesInner.animate({opacity:1});
    } else {
        menuOpciones.animate(stmo,600);
        opciones.animate(stop,600,null,function(){
            $(this).css({backgroundImage:stop.backgroundImage});
        });
        opcionesInner.animate({opacity:0});
    }
    tgop=!tgop;
}

/******************************API GOOGLE MAPS**********************************/
function inicializarMapa(centrar) {
	if ((centrar[0]==0)&&(centrar[1]==0)) {
		return;
	}
	var latlng = new google.maps.LatLng(centrar[0],centrar[1]);
	var tipo=google.maps.MapTypeId.SATELLITE;//HYBRID;//ROADMAP;//google.maps.MapTypeId.HYBRID
	var settings = {
		zoom: 20,
		center: latlng,
        disableDefaultUI: true,
		mapTypeControl: false,
		mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
		navigationControl: false,
		navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
		mapTypeId: tipo
	};

	map = new google.maps.Map(document.getElementById("divmapa"), settings);
    for (var v=0;v<=151;v++) {
        if (v!=0) imgPokes[v] = new google.maps.MarkerImage("pokes/"+v+".gif",
            new google.maps.Size(50,50),
            new google.maps.Point(0,0),
            new google.maps.Point(25,50)
        ); else {
            imgPasto = new google.maps.MarkerImage("pasto.png",
                new google.maps.Size(50,50),
                new google.maps.Point(0,0),
                new google.maps.Point(25,50)
            );
        }
    }
    step = 0;

    inicializarPokes(centrar);
}
function checkPokes() {
    var selfPos=map.getCenter();
    for (var i=rand(0,5);i<arrPokes.length;i+=rand(1,5)) {
        var dist=getDist(selfPos,arrPokes[i].getPosition());
        if (dist<0.0005) {
            if (!arrPokes[i].descubierto) {
                arrPokes[i].descubierto=true;
                arrPokes[i].setIcon(arrPokes[i].iconb);
            }
            if (dist<0.0003)
                arrPokes[i].setVisible(true);
            runAway(arrPokes[i],selfPos);
        } else if (dist>0.0030) {
            arrPokes[i].setVisible(false);
            nuevoPoke([selfPos.lat(),selfPos.lng()]);
            arrPokes=arrPokes.filter(function(v){return v.pid!=arrPokes[i].pid});
        } else {
            if (rand(0,5)==1)
                chaseHuman(arrPokes[i],selfPos);
            else
                arrPokes[i].setVisible(rand(0,30)==1);
        }
    }
}
function isCerca(p1,p2) {
    if (getDist(p1,p2)<0.0005) {
        return true;
    } else {
        return false;
    }
}
function runAway(poke,center) {
    var pos=poke.getPosition();
    pos.lat=pos.lat();
    pos.lng=pos.lng();
    if (center.lat()>pos.lat) pos.lat-=rand(1,5)/1000000;
    else                          pos.lat+=rand(1,5)/1000000;
    if (center.lng()>pos.lng) pos.lng-=rand(1,5)/1000000;
    else                          pos.lng+=rand(1,5)/1000000;
    poke.setPosition(new google.maps.LatLng(pos.lat,pos.lng));
}
function chaseHuman(poke,center) {
    var pos=poke.getPosition();
    pos.lat=pos.lat();
    pos.lng=pos.lng();
    if (center.lat()>pos.lat) pos.lat+=rand(1,5)/1000000;
    else                          pos.lat-=rand(1,5)/1000000;
    if (center.lng()>pos.lng) pos.lng+=rand(1,5)/1000000;
    else                          pos.lng-=rand(1,5)/1000000;
    poke.setPosition(new google.maps.LatLng(pos.lat,pos.lng));
}
function inicializarPokes(centrar) {
    var cant=rand(3,5);
    for (var i=0;i<cant;i++) {
        nuevoPoke(centrar);
    }
}
function nuevoPoke(centrar) {
    var ref = rand(1,151);
    var pos = new google.maps.LatLng(centrar[0]+rand(-15,15)/10000,centrar[1]+rand(-15,15)/10000);
    //var pos = new google.maps.LatLng(centrar[0]+0.0001,centrar[1]+0.0001);
    var poke = new google.maps.Marker({
          position: pos,
          map: map,
          title:'???',
          pid: pids,
          ref: ref,
          icon: imgPasto,
          descubierto: false,
          iconb: imgPokes[ref]
    });
    arrPokes.push(poke);
    pids++;
}
function showError(txt) {
    error.html(txt)
        .slideDown(500)
        .delay(3000)
        .slideUp(500);
}
function W_resize() {
    W=window.screen.width;
    H=window.screen.height;
    M=minimo(W,H);
    N=maximo(W,H);
    emap=document.getElementById('divmapa');
    emap.style.width=(M*1/2*Math.PI)+'px';
    emap.style.height=(M*1/2*Math.PI)+'px';
    emap.style.left=((W-M)/2)+'px';
    emap.style.top=((H-M)/2)+'px';
    if (lastPos)
        inicializarMapa([lastPos.coords.latitude,lastPos.coords.longitude]);
    menuOpciones.css(ret_sty(1,tgop));
    opciones.css(ret_sty(0,tgop));
    opcionesInner.css({opacity:(tgop?1:0)});
}
function minimo(n,m) {
    if (n<m) return m;
    else return n;
}
function maximo(n,m) {
    if (n>m) return m;
    else return n;
}
</script>
<style>
* {padding:0px;margin:0px}
#divmapawrap {width:100%;height:100%;position:absolute;z-index:1;top:0px;left:0px;background-color:#08e;overflow:hidden;}
#divmapa {width:100%;height:100%;position:absolute;z-index:1;top:0px;left:0px;}
#radius {width:100%;height:100%;position:absolute;z-index:5;top:0;left:0; background-image:url(radius.png);background-repeat:no-repeat;background-size:40%;background-position:center;}
#avatar {width:100%;height:100%;position:absolute;z-index:10;top:0;left:0; background-image:url(avatar_r.png);background-repeat:no-repeat;background-size:40%;background-position:center;}
#error {width:100%;color:#fff;position:absolute;z-index:15;top:0;left:0;display:none; background-color:rgba(255,0,0,0.7);text-align:center;font-size:5vh;font-family:arial;padding:5vh 0;}
#canvas {width:100%;height:100%;position:absolute;z-index:20;top:0px;left:0px;}
#opciones {position:absolute;height:auto;background-size:100%;}
#menuOpciones {overflow:hidden;z-index:23;position:absolute;}
#opcionesInner {width:100%;height:100%;opacity:0;background-color:rgba(255,255,255,0.7);}
</style>
</head>
<body>

<div id='divmapawrap'>
    <div id='divmapa'></div>
</div>
<div id='radius'></div>
<div id='avatar'></div>
<div id='error'></div>
<canvas id='canvas'></canvas>
<div id='menuOpciones'>
    <div id='opcionesInner'></div>
    <img id='opciones' src='button_o.png'/>
</div>

</body>
</html>
